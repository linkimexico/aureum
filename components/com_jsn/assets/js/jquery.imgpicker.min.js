!function(e,t,i,a){function r(t,i){this.options=e.extend({},s,i),this.container=e(t),this.init()}e.support.xhrUpload=!!(t.XMLHttpRequest&&t.File&&t.FileReader&&t.FileList&&t.Blob&&t.FormData),e.support.getUserMedia=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),e.support.Jcrop=!!e.Jcrop,e.support.Webcam=!!t.Webcam;var o,n="imgPicker",s={url:"server/upload.php",crop:!0,aspectRatio:null,minSize:null,maxSize:null,setSelect:null,swf:"assets/webcam.swf",swfSize:[470,350],data:{},messages:{selectimg:"Please select a image to upload",parsererror:"Invalid response",webcamerror:"Webcam Error: ",uploading:"Uploading...",error:"Unexpected error",datauri:"Cannot locate image format in Data URI",webcamjs:"Flash webcam not found",upgrade:"This feature is not available in this browser",loading:"Loading image...",saving:"Saving...",jcrop:"jQuery Jcrop not found",minCropWidth:"Crop selection requires a minimum width of ",maxCropWidth:"Crop selection exceeds maximum width of ",minCropHeight:"Crop selection requires a height of ",maxCropHeight:"Crop selection exceeds maximum height of ",img404:"Error 404: No image was found"}},p=0;r.prototype={init:function(){this.elem(".ip-upload").on("change","input",e.proxy(this.upload,this)),this.elem(".ip-webcam").on("click",e.proxy(this.webcam,this)),this.elem(".ip-edit").on("click",e.proxy(this.edit,this)),this.elem(".ip-delete").on("click",e.proxy(this._delete,this)),this.elem(".ip-cancel").on("click",e.proxy(this.reset,this)),this.options.dropZone===a&&(this.options.dropZone=this.container);var t=this,i=e('[data-ip-modal="#'+this.container.attr("id")+'"]');i.length&&(this.container.on({"show.ip.modal":function(){t.container.fadeIn(150,function(){e(this).trigger("shown.ip.modal",t)})},"hide.ip.modal":function(){t.container.fadeOut(150,function(){t.reset(),e(this).trigger("hidden.ip.modal",t)})}}),i.on("click",function(e){e.preventDefault(),t.modal("show"),t.elem(".ip-close").off().on("click",function(){t.modal("hide")})}),this.options.dropZone===a&&(this.options.dropZone=this.elem(".ip-modal-content"))),this.options.dropZone&&this.options.dropZone.on("dragenter",function(e){e.stopPropagation(),e.preventDefault()}).on("dragover",function(e){e.stopPropagation(),e.preventDefault()}).on("drop",function(e){e.preventDefault(),e.originalEvent.dataTransfer.files&&e.originalEvent.dataTransfer.files[0]&&(t.reset(),t.handleFileUpload(e.originalEvent.dataTransfer.files[0]))}),this.options.loadComplete&&this.load()},modal:function(e){this.container.trigger(e+".ip.modal")},load:function(){var t=this;e.ajax({url:this.options.url,dataType:"json",data:{action:"load",data:this.getData()},success:function(e){t.dispatch("loadComplete",e)}})},upload:function(t){return this.reset(),e.support.xhrUpload?(t.target.files&&t.target.files[0]&&this.handleFileUpload(t.target.files[0]),void e(t.target).val("")):this.iframeTransport(t)},iframeTransport:function(t){var i,a,r=this,o=e(t.target),n=o.parent(),s=o.clone();this.dispatch("uploadProgress",100),i=e('<iframe name="iframe-transport-'+(p+1)+'" style="display:none;"></iframe>').appendTo("body").on("load",function(){r.dispatch("uploadProgressComplete",function(){try{var t=e.parseJSON(i.contents().find("body").html())}catch(o){}t?(r.alert("","hide"),r.uploadComplete(t)):r.alert(r.i18n("parsererror"),"error"),setTimeout(function(){i.remove(),a.remove(),n.append(s)},100)})}),a=e('<form style="display:none;"><form/>'),a.prop("method","POST"),a.prop("action",this.options.url),a.prop("target",i.prop("name")),a.prop("enctype","multipart/form-data"),a.prop("encoding","multipart/form-data"),a.prop({action:this.options.url,target:i.prop("name")}),a.append(o),a.append('<input type="hidden" name="action" value="upload"/>');var l=this.getData();l&&e.each(l,function(t,i){e('<input type="hidden"/>').prop("name","data["+t+"]").val(i).appendTo(a)}),a.appendTo("body").trigger("submit")},webcam:function(){if(this.reset(),!e.support.getUserMedia)return this.flashWebcam();var a=e("<video autoplay></video>");this.elem(".ip-preview").html(a),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var r=this;navigator.getUserMedia({video:!0},function(e){try{a.attr("src",t.URL.createObjectURL(o=e))}catch(n){var s=i.querySelector("video");o=e,s.srcObject=o,s.play()}r.elem(".ip-preview, .ip-cancel").show(),r.elem(".ip-capture").on("click",function(){var e=i.createElement("canvas"),t=e.getContext("2d");e.width=a[0].videoWidth,e.height=a[0].videoHeight,t.drawImage(a[0],0,0),r.reset(),r.handleFileUpload(e.toDataURL("image/jpeg"))}).show()},function(e){return"PermissionDeniedError"==e.name?r.flashWebcam():void r.alert(r.i18n("webcamerror")+e.name,"error")})},flashWebcam:function(){if(!e.support.xhrUpload)return this.alert(this.i18n("upgrade"),"error");var t=this;Webcam.error=function(){return t.elem(".ip-preview").html(""),t.alert("Webcam not detected.","error")},this.elem(".ip-preview").html(Webcam.getHtml(this.options.swf,this.options.swfSize)).show();var t=this;Webcam.loaded=function(){t.elem(".ip-cancel").show(),t.elem(".ip-capture").on("click",function(){var e=Webcam.snap();t.reset(),t.handleFileUpload(e)}).show()}},handleFileUpload:function(t){if(!t)return this.alert(this.i18n("selectimg"),"error");if(!t.name){if(!t.match(/^data\:image\/(\w+)/))return this.alert(this.i18n("datauri"),"error");var i=t.replace(/^data\:image\/\w+\;base64\,/,"");t=new Blob([this.base64DecToArr(i)],{type:"image/jpeg"})}var a=this;this.elem(".ip-upload input, .ip-webcam").prop("disabled",!0),xhr=e.ajaxSettings.xhr(),xhr.open("POST",this.options.url,!0),xhr.upload.onprogress=function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100);a.dispatch("uploadProgress",t)}},xhr.onload=function(){setTimeout(function(){a.elem(".ip-upload input, .ip-webcam").prop("disabled",!1),a.dispatch("uploadProgressComplete",function(){if(200==xhr.status){try{var t=e.parseJSON(xhr.responseText)}catch(i){}if(t)return a.alert("","hide"),a.uploadComplete(t)}a.alert(a.i18n("parsererror"),"error")})},500)};var r=new FormData;r.append("action","upload"),r.append("file",t),e.each(this.getData(),function(e,t){r.append("data["+e+"]",t)}),xhr.send(r)},uploadProgress:function(e){this.elem(".ip-progress").fadeIn().find(".progress-bar").css("width",e+"%")},uploadProgressComplete:function(t){this.elem(".ip-progress").fadeOut(function(){e(this).find(".progress-bar").css("width","0%"),t()})},uploadComplete:function(e){return e.error?this.alert(this.i18n(e.error||"error"),"error"):(this.dispatch("uploadSuccess",e),void(this.options.crop&&this.crop(e)))},crop:function(t){if(this.reset(),!e.support.Jcrop)return this.dispatch("alert",this.i18n("jcrop"),"error");var i,a=this,r=0,o=function(e){i=e},n={onChange:o,onRelease:o,bgColor:"white"},s=this.options.url+"&action=preview&file="+t.name+"&width=800",p=this.getData();for(var l in p)s+="&data["+l+"]="+p[l];var c=function(e){r+=e,Math.abs(r)>=360&&(r=0),h(s+"&rotate="+r)};this.options.aspectRatio&&(n.aspectRatio=this.options.aspectRatio),this.options.setSelect&&(n.setSelect=this.options.setSelect),this.options.minSize&&(n.minSize=this.options.minSize),this.options.maxSize&&(n.maxSize=this.options.maxSize);var h=function(i){i+="&rand="+(new Date).getTime(),a.alert(a.i18n("loading"),"loading");var o=new Image;o.onload=function(){a.alert("","hide"),a.elem(".ip-cancel").show();var o=e('<img src="'+i+'" style="visibility:hidden;">');a.elem(".ip-preview").html(o),90==Math.abs(r)||270==Math.abs(r)?n.trueSize=[t.height,t.width]:n.trueSize=[t.width,t.height],a.elem(".ip-preview, .ip-rotate, .ip-info, .ip-save").show(),o.Jcrop(n)},o.onerror=function(){a.alert(a.i18n("img404"),"error")},o.src=i};h(s),this.elem(".ip-rotate-ccw").on("click",function(){c(-90)}).show(),this.elem(".ip-rotate-cw").on("click",function(){c(90)}).show(),this.elem(".ip-save").on("click",function(){e.ajax({url:a.options.url,type:"POST",dataType:"json",data:{action:"crop",image:t.name,coords:i,rotate:r,data:a.getData()},beforeSend:function(){a.validateCrop(i||{})&&(a.elem(".ip-save").prop("disabled",!0),a.alert(a.i18n("saving"),"loading"))},success:function(e){return e.error?a.alert(a.i18n(e.error||"error"),"error"):(a.reset(),a.setImage(e),void a.dispatch("cropSuccess",e))},error:function(){a.alert(a.i18n("parsererror"),"error")},complete:function(){a.elem(".ip-save").prop("disabled",!1)}})})},validateCrop:function(e){var t=this.options;if(t.minSize){if(t.minSize[0]&&(e.w||0)<t.minSize[0])return this.alert(this.i18n("minCropWidth")+t.minSize[0]+"px","error");if(t.maxSize&&t.maxSize[0]&&(e.w||0)>t.maxSize[0])return this.alert(this.i18n("maxCropWidth")+t.maxSize[0]+"px","error");if(t.minSize[1]&&(e.h||0)<t.minSize[1])return this.alert(this.i18n("minCropHeight")+t.minSize[1]+"px","error");if(t.maxSize&&t.maxSize[1]&&(e.h||0)>t.maxSize[1])return this.alert(this.i18n("maxCropHeight")+t.maxSize[1]+"px","error")}return!0},_delete:function(){this.image&&this.image.name&&e.post(this.options.url,{action:"delete",data:this.getData(),file:this.image.name}),this.elem(".ip-delete, .ip-edit").hide(),this.dispatch("deleteComplete")},edit:function(){this.image&&this.crop(this.image)},setImage:function(e){this.image=e,this.elem(".ip-delete, .ip-edit").show()},reset:function(){if(this.alert("","hide"),this.elem(".ip-preview").html("").fadeOut(),this.elem(".ip-save, .ip-capture, .ip-rotate-cw, .ip-rotate-ccw").off().hide(),this.elem(".ip-cancel, .ip-rotate, .ip-info").hide(),o){try{o.getTracks()[0].stop()}catch(e){}delete o}},alert:function(t,i){if(this.options.alert)return this.options.alert(t,i);var a=this.container.find(".ip-alert");return"hide"==i?a.hide():void a.html(t).removeClass("success"==i?"alert-danger alert-warning":"warning"==i||"loading"==i?"alert-danger alert-success":"alert-warning alert-danger").addClass("alert-"+("success"==i?"success":"warning"==i||"loading"==i?"warning":"danger")).append(e('<a class="dismiss">&times;</a>').on("click",function(){a.hide()})).show()},getData:function(){return"function"==typeof this.options.data?this.options.data():this.options.data},i18n:function(e){return this.options.messages[e]||e.toString()},elem:function(e){return this.container.find(e)},dispatch:function(){var e=arguments[0].replace(/^on/i,""),t=Array.prototype.slice.call(arguments,1),i=this.options[e]||this[e];return i&&"function"==typeof i?(i.apply(this,t),!0):!1},b64ToUint6:function(e){return e>64&&91>e?e-65:e>96&&123>e?e-71:e>47&&58>e?e+4:43===e?62:47===e?63:0},base64DecToArr:function(e,t){for(var i,a,r=e.replace(/[^A-Za-z0-9\+\/]/g,""),o=r.length,n=t?Math.ceil((3*o+1>>2)/t)*t:3*o+1>>2,s=new Uint8Array(n),p=0,l=0,c=0;o>c;c++)if(a=3&c,p|=this.b64ToUint6(r.charCodeAt(c))<<18-6*a,3===a||o-c===1){for(i=0;3>i&&n>l;i++,l++)s[l]=p>>>(16>>>i&24)&255;p=0}return s}},e.fn[n]=function(t){return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new r(this,t))}),this}}(jQuery,window,document);var time=function(){return"?"+(new Date).getTime()};window.Webcam={isLoaded:!1,loaded:null,complete:null,error:null,getHtml:function(e,t){return'<object id="webcam_movie_obj" type="application/x-shockwave-flash" width="'+t[0]+'" height="'+t[1]+'"><param name="allowScriptAccess" value="always"/><param name="allowFullScreen" value="false"/><param name="movie" value="'+e+'"/><param name="wmode" value="transparent"/><param name="flashvars" value="width='+t[0]+"&height="+t[1]+"&dest_width="+1.5*t[0]+"&dest_height="+1.5*t[1]+'&image_format=jpeg&jpeg_quality=100&force_flash=false"></object>'},snap:function(){if(!this.isLoaded)return alert("JPEGCam ERROR: Movie is not loaded yet");var e=document.getElementById("webcam_movie_obj"),t="";e||alert("JPEGCam ERROR: Cannot locate movie #webcam_movie_obj in DOM");try{t="data:image/jpeg;base64,"+e._snap()}catch(i){}return t},flashNotify:function(e,t){switch(e){case"flashLoadComplete":this.isLoaded=!0;break;case"cameraLive":this.loaded();break;case"error":this.error(t)}}};